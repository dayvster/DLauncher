name: Commit Lint

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  lint-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gather commits range
        id: range
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base_ref=${{ github.event.pull_request.base.ref }}
            # fetch base ref and compute range
            git fetch origin "$base_ref":refs/remotes/origin/$base_ref || true
            RANGE="origin/$base_ref..HEAD"
          else
            # push event: use before..after
            before=${{ github.event.before }}
            after=${{ github.sha }}
            if [ "$before" = "0000000000000000000000000000000000000000" ]; then
              # initial commit range: just check latest
              RANGE="$after"
            else
              RANGE="$before..$after"
            fi
          fi
          echo "range=$RANGE" >> $GITHUB_OUTPUT

      - name: Check commit subjects for Conventional Commits
        env:
          RANGE: ${{ steps.range.outputs.range }}
        run: |
          set -euo pipefail
          echo "Checking commits in range: $RANGE"
          # gather commits; if RANGE is a single sha, handle that
          if git rev-parse --verify "$RANGE" >/dev/null 2>&1; then
            commits=$(git rev-list --no-merges $RANGE)
          else
            # fallback: recent 100 commits
            commits=$(git rev-list --no-merges HEAD -n 100)
          fi

          if [ -z "$commits" ]; then
            echo "No commits to check."
            exit 0
          fi

          # Conventional commit regex (allowing bugfix and type aliases)
          re='^(feat|fix|bugfix|docs|style|refactor|perf|test|chore|type)(\([^)]*\))?: .+'

          failed=0
          for c in $commits; do
            subj=$(git log --format=%s -n 1 $c)
            if ! echo "$subj" | grep -Eq "$re"; then
              echo "Invalid commit message subject for $c: '$subj'"
              failed=1
            fi
          done

          if [ $failed -ne 0 ]; then
            echo "One or more commit messages do not follow Conventional Commits." >&2
            exit 1
          fi

          echo "All commit subjects look good."
